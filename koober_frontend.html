<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KOOBERA Trading</title>

  <!-- Styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header>
      <h1>KOOBERA Predictive Trading</h1>
    </header>

    <!-- Search -->
    <section id="searchSection">
      <input id="stockSearch" type="text" placeholder="Search Indian Stock (e.g., TCS, RELIANCE)">
      <button onclick="searchStock()">Search</button>
    </section>

    <!-- Stock Info -->
    <section id="stockInfo">
      <h2 id="stockName">Select a stock</h2>
      <i id="stockIcon" class="fa-solid fa-chart-line"></i>
      <div class="stock-price">
        <span class="price">—</span>
        <span class="change">—</span>
      </div>
    </section>

    <!-- Chart -->
    <section>
      <canvas id="stockChart"></canvas>
    </section>
  </div>

  <script>
    const BACKEND_URL = "https://trading-backend-bdbt.onrender.com";
    let socket = null;
    let currentStock = null;
    let stockChart = null;

    // Example database (meta only, not prices)
    const stockDatabase = {
      "TCS": { name: "Tata Consultancy Services", symbol: "TCS", icon: "fa-building", sector: "IT" },
      "RELIANCE": { name: "Reliance Industries", symbol: "RELIANCE", icon: "fa-industry", sector: "Energy" }
    };

    // Initialize chart
    function initChart(initialData = [0]) {
      const ctx = document.getElementById("stockChart").getContext("2d");
      if (stockChart) stockChart.destroy();
      stockChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [new Date().toLocaleTimeString()],
          datasets: [{
            label: "Price (₹)",
            data: initialData,
            borderColor: "#3e95cd",
            fill: false,
            tension: 0.1
          }]
        },
        options: { responsive: true }
      });
    }

    // Init socket
    function initSocket() {
      if (window.io && !socket) {
        socket = io(BACKEND_URL, { transports: ["websocket"] });

        socket.on("connect", () => console.log("Connected:", socket.id));

        socket.on("stock_update", (data) => {
          if (!currentStock) return;

          const curBase = (currentStock.symbol || "").toUpperCase();
          const incomingBase = (data.symbol || "").toUpperCase();
          if (curBase !== incomingBase) return;

          currentStock.price = Number(data.price ?? currentStock.price);
          currentStock.changePercent = Number(data.changePercent ?? 0);

          // Update DOM
          document.querySelector(".stock-price .price").textContent = `₹${currentStock.price.toLocaleString("en-IN")}`;
          const changeEl = document.querySelector(".stock-price .change");
          const sign = currentStock.changePercent >= 0 ? "+" : "";
          changeEl.textContent = `${sign}${currentStock.changePercent.toFixed(2)}%`;
          changeEl.className = "change " + (currentStock.changePercent >= 0 ? "price-up" : "price-down");

          // Update Chart
          if (stockChart) {
            stockChart.data.datasets[0].data.push(currentStock.price);
            stockChart.data.labels.push(new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" }));
            if (stockChart.data.datasets[0].data.length > 60) {
              stockChart.data.datasets[0].data.shift();
              stockChart.data.labels.shift();
            }
            stockChart.update();
          }
        });

        socket.on("stockError", (err) => console.warn("Stock error:", err));
      }
    }

    // Unsubscribe previous
    function socketUnsubscribe() {
      if (socket && socket.connected) socket.emit("unsubscribeStock");
    }

    // Select stock
    function selectStock(symbol) {
      if (!symbol) return;
      const base = symbol.toUpperCase().trim();

      if (stockDatabase[base]) {
        currentStock = { ...stockDatabase[base], price: 0, changePercent: 0 };
      } else {
        currentStock = { name: base, symbol: base, price: 0, changePercent: 0, icon: "fa-chart-line", sector: "" };
      }

      document.getElementById("stockName").textContent = currentStock.name;
      document.getElementById("stockIcon").className = `fa-solid ${currentStock.icon}`;
      document.querySelector(".stock-price .price").textContent = "Loading...";
      document.querySelector(".stock-price .change").textContent = "—";

      initChart([0]);
      if (socket && socket.connected) {
        socketUnsubscribe();
        socket.emit("subscribeStock", { symbol: base, intervalMs: 1000 });
      }
    }

    // Search
    function searchStock() {
      const val = document.getElementById("stockSearch").value;
      if (val) selectStock(val);
    }

    // Init
    initChart([0]);
    initSocket();
  </script>
</body>
</html>
